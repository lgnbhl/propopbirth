test_that("Snapshot tests for forecasting fertility rate", {

  # create input data ----
    input_fer <- tibble::tibble(
      spatial_unit = rep("Aarau", 70L),
      nat = rep(c("ch", "int"), each = 35L),
      age = rep(seq(15, 49, by = 1), 2),
      fer = c(
        0, 0, 0.009876543209876543, 0, 0.004705882352941176, 
        0, 0.004282655246252677,
        0.004, 0.003875968992248062, 0.017361111111111112, 0.019471488178025034,
        0.022613065326633167, 0.03260869565217391, 0.024896265560165973,
        0.05517241379310345, 0.07393364928909953, 0.09664694280078895,
        0.10909090909090909, 0.10623556581986143, 0.14094775212636695,
        0.10353535353535354, 0.09212121212121212, 0.08731241473396999,
        0.045779685264663805, 0.026277372262773723, 0.03081232492997199, 0,
        0.018072289156626505, 0.01263823064770932, 0.003125, 0.0029806259314456036, 0,
        0, 0, 0, 0, 0, 0, 0, 0.028985507246376812, 0.02666666666666667,
        0.04819277108433735, 0.09433962264150944, 0.0392156862745098,
        0.03225806451612903, 0.056338028169014086, 0.11180124223602485,
        0.10138248847926268, 0.10699588477366255, 0.11409395973154363,
        0.09970674486803519, 0.13529411764705881, 0.17891373801916932,
        0.06116207951070336, 0.12218649517684887, 0.11295681063122924,
        0.12861736334405144, 0.08408408408408409, 0.07250755287009064,
        0.046357615894039736, 0.056140350877192984, 0.034722222222222224,
        0.03546099290780142, 0, 0.006711409395973154, 0, 0, 0, 0, 0
      )
    )
    
    forecast_tfr <- tibble::tibble(
      spatial_unit = rep("Aarau", 130L),
      nat = rep(c("ch", "int"), each = 65L),
      year = rep(seq(2011, 2075, by = 1), 2),
      tfr = c(
        1.3317180993542383, 1.2905418882383055, 1.3109546955687157, 1.111916627253612,
        1.30666869372653, 1.5624560873216693, 1.1577805428762786, 1.1259319259132576,
        1.2422815308477662, 1.1988829661921492, 1.2442585827987873,
        1.1661266463168989, 1.0121007626628005, 1.0626711034546368,
        1.0563376597424483, 1.0500042160302598, 1.0436707723201835,
        1.0389948523807107, 1.0338652968785027, 1.0283291806117631,
        1.0224335782550042, 1.0162255645991536, 1.0097522143623792,
        1.0030606022919528, 0.9961978031351464, 0.9892108916101279, 0.982146942493273,
        0.9750530304881977, 0.9679762303712778, 0.9609636168315774,
        0.9540622646891279, 0.9473192486184416, 0.9407816433667904,
        0.9344965237105498, 0.928510964353336, 0.9228720400860766, 0.91762682555418,
        0.9128223956213333, 0.9085058249474969, 0.9047241882944945, 0.901524560409598,
        0.8989540159964235, 0.8970596298604505, 0.8958884766616393,
        0.8954876312345732, 0.8954876312345732, 0.8954876312345732,
        0.8954876312345732, 0.8954876312345732, 0.8954876312345732,
        0.8954876312345732, 0.8954876312345732, 0.8954876312345732,
        0.8954876312345732, 0.8954876312345732, 0.8954876312345732,
        0.8954876312345732, 0.8954876312345732, 0.8954876312345732,
        0.8954876312345732, 0.8954876312345732, 0.8954876312345732,
        0.8954876312345732, 0.8954876312345732, 0.8954876312345732,
        1.9372076690835396, 1.755635500403377, 1.5330832216352193, 2.600794521482836,
        1.8576157827302706, 1.894356294917059, 2.3848535073420325, 1.990104826882635,
        1.6125283802807857, 1.9003827175532302, 1.9986812756844305,
        1.8652936716833775, 1.8814830581283348, 1.8164377201298083,
        1.7919094922255965, 1.7673812643213846, 1.742853036354063, 1.7249389943899587,
        1.7056389130302705, 1.6851065805822145, 1.6634957846836187,
        1.6409603137290105, 1.6176539557054639, 1.593730498716468, 1.5693437308364082,
        1.544647440110566, 1.5197954146715347, 1.4949414426810108, 1.4702393121260684,
        1.4458428109937813, 1.4219057275622617, 1.398581849934999, 1.3760249659535475,
        1.354388863837812, 1.3338273316330742, 1.3144941575592384, 1.2965431294869632,
        1.2801280357234646, 1.2654026642267127, 1.2525208030710928,
        1.2416362403309904, 1.2329027641389985, 1.2264741625403985, 1.222504223609576,
        1.2211467357119545, 1.2211467357119545, 1.2211467357119545,
        1.2211467357119545, 1.2211467357119545, 1.2211467357119545,
        1.2211467357119545, 1.2211467357119545, 1.2211467357119545,
        1.2211467357119545, 1.2211467357119545, 1.2211467357119545,
        1.2211467357119545, 1.2211467357119545, 1.2211467357119545,
        1.2211467357119545, 1.2211467357119545, 1.2211467357119545,
        1.2211467357119545, 1.2211467357119545, 1.2211467357119545
      ),
      category = rep(
        rep(c("past", "lm", "cubic", "constant"), 2), 
        rep(c(13L, 3L, 29L, 20L), 2)
      )
    )
    
    forecast_mab <- tibble::tibble(
      spatial_unit = rep("Aarau", 130L),
      nat = rep(c("ch", "int"), each = 65L),
      year = rep(seq(2011, 2075, by = 1), 2),
      mab = c(
        32.73168671367248, 31.758908450546425, 33.18058082482918, 33.436254295979666,
        33.777815942185384, 33.81297190258293, 33.69255743722953, 33.78006589626685,
        33.19203655784898, 33.315090996253886, 33.37085331622384, 32.184920166214916,
        33.63685123663244, 33.24655292568408, 33.18979233097833, 33.13303173627258,
        33.07627114156684, 33.055112164661885, 33.04398970545401, 33.03599113507959,
        33.029701587581805, 33.02453188306502, 33.02016929185231, 33.01642416948251,
        33.013171226790845, 33.01032256226986, 33.007813688391465, 33.005595631880986,
        33.00363016251521, 33.00188675749709, 33.00034058699363, 32.99897112995739,
        32.99776119475699, 32.9966962086872, 32.99576369128819, 32.994952856493526,
        32.99425430706532, 32.99365979642753, 32.99316204057205, 32.992754567742,
        32.992431597013095, 32.9921879392598, 32.992018915659806, 32.99192029008387,
        32.991888212584485, 32.991888212584485, 32.991888212584485,
        32.991888212584485, 32.991888212584485, 32.991888212584485,
        32.991888212584485, 32.991888212584485, 32.991888212584485,
        32.991888212584485, 32.991888212584485, 32.991888212584485,
        32.991888212584485, 32.991888212584485, 32.991888212584485,
        32.991888212584485, 32.991888212584485, 32.991888212584485,
        32.991888212584485, 32.991888212584485, 32.991888212584485,
        29.559140595041534, 30.585210078173493, 30.480482821224165,
        28.750457479710438, 30.299696836601633, 29.78395139462011, 29.021948928279375,
        29.332473385592372, 29.639471501814764, 29.683602453149142,
        31.857553809416384, 30.450291043211088, 31.093898105510792,
        31.386149365720215, 31.576677314908302, 31.76720526409639, 31.95773321328449,
        32.08007865531507, 32.18430770272969, 32.27462668259194, 32.35382922203492,
        32.42388283573524, 32.4862351834589, 32.5419881842682, 32.592003637034935,
        32.63697065581682, 32.67745054891415, 32.71390773011653, 32.746731634290384,
        32.77625264395941, 32.80275391347618, 32.826480312837134, 32.84764530494321,
        32.86643631157607, 32.883018955202616, 32.89754045172125, 32.910132353066714,
        32.920912785754794, 32.92998829417203, 32.93745537070264, 32.94340173536475,
        32.947907413323506, 32.951045647983825, 32.95288367932609, 32.953483411022866,
        32.953483411022866, 32.953483411022866, 32.953483411022866,
        32.953483411022866, 32.953483411022866, 32.953483411022866,
        32.953483411022866, 32.953483411022866, 32.953483411022866,
        32.953483411022866, 32.953483411022866, 32.953483411022866,
        32.953483411022866, 32.953483411022866, 32.953483411022866,
        32.953483411022866, 32.953483411022866, 32.953483411022866,
        32.953483411022866, 32.953483411022866
      ),
      category = rep(
        rep(c("past", "lm", "Bezier", "constant"), 2), 
        rep(c(13L, 3L, 29L, 20L), 2)
      )
    )
    
    fertility_forecast <- forecast_fertility_rate(
      fer_dat = input_fer,
      tfr_dat = forecast_tfr,
      mab_dat = forecast_mab,
      year_start = 2024,
      year_end = 2075
    )
  
    expect_snapshot(constructive::construct(fertility_forecast))
})
